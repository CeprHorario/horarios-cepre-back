steps:
  # 1. Autenticarse en Artifact Registry
  - name: "gcr.io/cloud-builders/docker"
    args: ["login", "-u", "oauth2accesstoken", "-p", "$ACCESS_TOKEN", "southamerica-west1-docker.pkg.dev"]

  # 2. Construir la imagen de Docker
  - name: "gcr.io/cloud-builders/docker"
    args: [
      "build",
      "-t", "southamerica-west1-docker.pkg.dev/$PROJECT_ID/horario-ceprunsa-repo/horario-ceprunsa:$SHORT_SHA",
      "."
    ]

  # 3. Subir la imagen a Artifact Registry
  - name: "gcr.io/cloud-builders/docker"
    args: [
      "push",
      "southamerica-west1-docker.pkg.dev/$PROJECT_ID/horario-ceprunsa-repo/horario-ceprunsa:$SHORT_SHA"
    ]

  # 4. Desplegar en Cloud Run
  - name: "gcr.io/google.com/cloudsdktool/cloud-sdk"
    entrypoint: "gcloud"
    args:
      - "run"
      - "deploy"
      - "horario-ceprunsa"
      - "--image=southamerica-west1-docker.pkg.dev/$PROJECT_ID/horario-ceprunsa-repo/horario-ceprunsa:$SHORT_SHA"
      - "--platform=managed"
      - "--region=southamerica-west1"
      - "--allow-unauthenticated"

images:
  - "southamerica-west1-docker.pkg.dev/$PROJECT_ID/horario-ceprunsa-repo/horario-ceprunsa:$SHORT_SHA"

